<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="foundation.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="d3-context-menu.css" />
    <!--<style>
        #topNavigationBar {
            width: 49%;
        }
        
        #topNavigationBar ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            background-color: #333;
        }
        
        #topNavigationBar li {
            display: inline;
        }
        
        #content {
            width: 49%;
            float: left;
        }
        
        #topNavigationBar li a {
            display: inline;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }
    </style>-->
    <!--<script src="https://d3js.org/d3.v3.min.js"></script>-->
    <script src="d3.v3.min.js"></script>
    <script src="dndTree.js"></script>
    <script src="d3-context-menu.js"></script>
    <script src="underscore-min.js"></script>
    <script src="jquery.js"></script>
    <script src="fastclick.js"></script>
    <script src="foundation.min.js"></script>
    <script src="bluebird.min.js"></script>
</head>

<body>
    <!--<div id="topNavigationBar">
        <div class="topNavigationBar-menu">
            <ul>
                <li><a href="#">Subject-Work-Relations</a></li>
                <li><a href="#">Subjects & Works</a></li>
                <li><a href="#">Persons</a></li>
                <li><a href="#">Languages</a></li>
                <li><a href="#">Logout</a></li>
            </ul>
        </div>
    </div>-->
    <FORM NAME="kt">
        <!--<INPUT type="hidden" name="fld">-->
        <!--<input type="checkbox" id="displayWorkTree" name="displayWorkTree"> Display Subject Tree (uncheck for Display Work Tree)-->
        <input type="radio" id="subject" name="displayTree" onclick="handleClick(this);" value="Subject" checked>Prameya
        <input type="radio" id="work" name="displayTree" onclick="handleClick(this);" value="Work">PramaaNa
    </FORM>
    <!--<FORM NAME="url">
        <INPUT TYPE="button" NAME="restService" id="restServiceUrl">
    </FORM>-->

    <div id="ViewNodeModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
        <h2 id="modalTitle">View Node</h2>
        <form id="ViewNodeForm">
            <div class="row">
                <div class="large-12 columns">
                    <label>Node id
                  <input type="text" class="inputName" id='ViewNodeId' placeholder="node id" disabled="true" />
                    <label>Node name
                  <input type="text" class="inputName" id='ViewNodeName' placeholder="node name"  disabled="true"/>
                     <label>Node order
                  <input type="text" class="inputName" id='ViewNodeOrder' placeholder="node order" />
                     <label>Node description
                  <!--<input type="text" class="inputName" id='ViewNodeDescription' placeholder="node description" />-->
                        <textarea id="ViewNodeDescription" class="inputName" placeholder="node description" rows="10" disabled="true"></textarea>
                <label>Node relation
                  <input type="text" class="inputName" id='ViewNodeRelation' placeholder="node relation"  disabled="true"/>
              </label>
                </div>
            </div>
        </form>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>

    <div id="RenameNodeModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
        <h2 id="modalTitle">Edit Node</h2>
        <form id="RenameNodeForm">
            <div class="row">
                <div class="large-12 columns">
                    <label>Node id
                  <input type="text" class="inputName" id='RenameNodeId' placeholder="node id" disabled="true" />
                             <label>Node name
                  <input type="text" class="inputName" id='RenameNodeName' placeholder="node name" />
                    <label>Node order
                  <input type="text" class="inputName" id='RenameNodeOrder' placeholder="node order" />
                      <label>Node description
                  <!--<input type="text" class="inputName" id='RenameNodeDescription' placeholder="node description" />-->
                        <textarea id="RenameNodeDescription" class="inputName" placeholder="node description" rows="10"></textarea>
                <label>Node relation
                  <input type="text" list="renameRelationList" class="inputName" id='RenameNodeRelation' placeholder="node relation" />
              </label>
                    <datalist id="renameRelationList">
                </datalist>
                </div>
            </div>
            <div class="row">
                <div class="large-8 columns">
                    &nbsp;
                </div>
                <div class="large-4 columns">
                    <!--<a href="#" class="button info" onclick="close_rename_node_modal()">Cancel</a>-->
                    <a href="#" class="button success" onclick="rename_node()">Update</a>
                </div>
            </div>
        </form>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>

    <div id="CreateNodeModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
        <h2 id="modalTitle">Create Node</h2>
        <form id="CreateNodeForm">
            <div class="row">
                <div class="large-12 columns">
                    <label>Node name
                  <input type="text" class="inputName" id='CreateNodeName' placeholder="node name" onchange="generateId()"/>
                    <label>Node id
                  <input type="text" class="inputName" id='CreateNodeId' placeholder="node id" />
                    <label>Node order
                  <input type="text" class="inputName" id='CreateNodeOrder' placeholder="node order" />
                      <label>Node description
                  <textarea id="CreateNodeDescription" class="inputName" placeholder="node description" rows="10"></textarea>
                      <label>Node relation
                  <input type="text" list="createRelationList" class="inputName" id='CreateNodeRelation' placeholder="node relation" />
              </label>
                    <datalist id="createRelationList">
                </datalist>
                </div>
            </div>
            <div class="row">
                <div class="large-8 columns">
                    &nbsp;
                </div>
                <div class="large-4 columns">
                    <!--<a href="#" class="button info" onclick="close_create_node_modal()">Cancel</a>-->
                    <a href="#" class="button success" onclick="create_node()">Create</a>
                </div>
            </div>
        </form>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>

    <div id="MoveNodeModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
        <h2 id="modalTitle">Move Node</h2>
        <form id="MoveNodeForm">
            <div class="row">
                <div class="large-12 columns">
                    <label>Node id
                  <input type="text" class="inputName" id='MoveNodeId' placeholder="node id" />
                    <label>Node Order
                  <input type="text" class="inputName" id='MoveNodeOrder' placeholder="node order" />
                    <label> New Parent Node
                  <input type="text" list="MoveParentList" class="inputName" id='MoveParentNode' placeholder="parent node list" />
              </label>
                    <datalist id="MoveParentList">
                </datalist>
                </div>
            </div>
            <div class="row">
                <div class="large-8 columns">
                    &nbsp;
                </div>
                <div class="large-4 columns">
                    <!--<a href="#" class="button info" onclick="close_move_node_modal()">Cancel</a>-->
                    <a href="#" class="button success" onclick="move_node()">Move</a>
                </div>
            </div>
        </form>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>

    <div id="ConnectNodeModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle_Connect" aria-hidden="true" role="dialog">
        <h2 id="modalTitle_Connect">Connect Node</h2>
        <form id="CreateWorkNodeForm">
            <div class="row">
                <div class="large-12 columns">
                    <label>Subject Node Id
                  <input type="text" list="list_create_subject" class="inputName" id='ConnectSubjectNode' placeholder="Prameya node id" disabled />
                    <datalist id="list_create_subject">
                </datalist>
                    <label>Work Node Id
                  <input type="text" list="list_create_work" class="inputName" id='ConnectWorkNode' placeholder="work node id" disabled/>
              </label>
                    <datalist id="list_create_work">
                </datalist>
                    <label>Relation
                  <input type="text" list="list_create_subject_work_relation" class="inputName" id='ConnectNodeRelation' placeholder="node relation" />
              </label>
                    <datalist id="list_create_subject_work_relation">
                </datalist>
                </div>
            </div>
            <div class="row">
                <div class="large-8 columns">
                    &nbsp;
                </div>
                <div class="large-4 columns">
                    <!--<a href="#" class="button info" onclick="close_create_node_modal()">Cancel</a>-->
                    <a href="#" class="button success" onclick="connect_subject_work_nodes()">Connect</a>
                </div>
            </div>
        </form>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>

    <div id="tree-container"></div>

    <script>
        function generateId() {
            id = $('#CreateNodeId').val();
            if (id.length > 0) return;
            name = $('#CreateNodeName').val();
            id = name.replace(/[ \-]/g, "");
            idl = id.length;
            if (idl > 20) {
                idtrunc = id.slice(0, 15) + id.slice(idl - 5, idl - 1);
                $('#CreateNodeId').val(idtrunc);
            } else $('#CreateNodeId').val(id);
        }

        function promise_works_or_subjects() {
            return new Promise(function(resolve, reject) {
                var result = d3.json(url + works_or_subjects_list).header("Authorization", "Basic " + btoa(auth)).get(function(err, content) {
                    if (err) {
                        console.log("error:", err);
                        reject(new Error(err));
                    } else {
                        $('#modalTitle_Connect').html("Connect " + works_or_subjects_list_sanskrit + " Node");
                        $(content[works_or_subjects_list]).each(function() {
                            if (works_or_subjects_list == "works")
                                $('#list_create_work').append("<option value=\"" + this.id + "\"></option>");
                            else $('#list_create_subject').append("<option value=\"" + this.id + "\"></option>");
                        });
                        resolve(result);
                    }
                });
                resolve(result);
            });
        }

        function promise_subject_work_relations() {
            return new Promise(function(resolve, reject) {
                var result = d3.json(url + "subject-work-relations").header("Authorization", "Basic " + btoa(auth)).get(function(err, content) {
                    if (err) {
                        console.log("error:", err);
                        reject(new Error(err));
                    } else {
                        $(content.relations).each(function() {
                            $('#list_create_subject_work_relation').append("<option value=\"" + this.id + "\"></option>");
                        });
                        resolve(result);
                    }
                });
                resolve(result);
            });
        }

        function promise_relations() {
            return new Promise(function(resolve, reject) {
                var result = d3.json(url + relations_list).header("Authorization", "Basic " + btoa(auth)).get(function(err, content) {
                    if (err) {
                        console.log("error:", err);
                        reject(new Error(err));
                    } else {
                        $(content.relations).each(function() {
                            $('#createRelationList').append("<option value=\"" + this.id + "\"></option>");
                            $('#renameRelationList').append("<option value=\"" + this.id + "\"></option>");
                        });
                        resolve(result);
                    }
                });
                resolve(result);
            });
        }

        function promise_tree() {
            return new Promise(function(resolve, reject) {
                var result = d3.json(url + displayTree).header("Authorization", "Basic " + btoa(auth)).get(function(err, content) {
                    if (err) {
                        console.log("error:", err);
                        reject(new Error(err));
                    } else {
                        svgElement = $("#tree-container").children().first();
                        svgElement.remove();
                        draw_tree(err, content);
                        resolve(result);
                    }
                });
                resolve(result);
            });
        }

        function handleClick(myRadio) {
            currentValue = myRadio.value;
            if (currentValue == "Subject") {
                displayTree = "tree";
                relations_list = "subject-subject-relations";
                works_or_subjects_list = "works";
                works_or_subjects_list_sanskrit = "PramaaNa";
            } else {
                displayTree = "tree-work";
                relations_list = "work-work-relations";
                works_or_subjects_list = "subjects";
                works_or_subjects_list_sanskrit = "Prameya";
            }
            promise_relations()
                .then(promise_works_or_subjects)
                .then(promise_subject_work_relations)
                .then(promise_tree).then(
                    //     function(response) {
                    //     console.log("all promises fulfilled. Success!", response);
                    // }
                );
        }
    </script>
    <script>
        // for the first initialization
        $('document').ready(function() {
            //  $("#restServiceUrl").load("restServiceUrl.txt");
            $(document).foundation();
            $(document).on('opened', '[data-reveal]', function() {
                var element = $(".inputName:visible").first();
                element.focus(function() {
                    this.selectionStart = this.selectionEnd = this.value.length;
                });
                element.focus();
            });
            $('#RenameNodeForm').submit(function(e) {
                rename_node();
                return false;
            });
            $('#CreateNodeForm').submit(function(e) {
                create_node();
                return false;
            });
            // var treeJSON = d3.json("tree.json", draw_tree);
            // var url = "http://127.0.0.1:5000/knowledgeTree/api/v1.0/";
            var url = "http://" + getIp() + ":5000/knowledgeTree/api/v1.0/";
            var auth = getauth();
        });
    </script>
</body>

</html>